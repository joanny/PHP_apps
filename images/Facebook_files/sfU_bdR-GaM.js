/*1326916006,176833976*/

if (window.CavalryLogger) { CavalryLogger.start_js(["Xm+zw"]); }

__d("MercuryAssert",[],function(c,e,f,d,b){function a(g){return g&&typeof g==='string'&&g.indexOf(':')!==-1;}d.exports={isParticipantID:function(g){if(!a(g))throw 'bad_participant_id';},allThreadID:function(g){g.forEach(this.isThreadID);},isThreadID:function(g){if(!a(g))throw 'bad_thread_id';}};});
__d("CallbackManager",["copyProperties"],function(d,f,g,e,c){var b=f('copyProperties');var a=function(){this._pending=[];this._resources={};};a.prototype={executeOrEnqueue:function(l,h){var i=h;var k=l;if(!(l instanceof Array)){k=[k];i=function(m){h(m[l]);};}var j=this._attemptCallback(i,k);if(j)return [];this._pending.push({fn:i,resources:k});return this._getUnavailableResources(k);},addResourcesAndExecute:function(h){b(this._resources,h);this._runPossibleCallbacks();},setResource:function(h,i){this._resources[h]=i;this._runPossibleCallbacks();},getResource:function(h){return this._resources[h];},dumpResources:function(){var h={};for(var i in this._resources){var j=this._resources[i];if(typeof j==='object')j=b({},j);h[i]=j;}return h;},_runPossibleCallbacks:function(){var h=this._pending;this._pending=[];var i=[];h.forEach(function(j){if(this._constructCallbackArg(j.resources,true)){i.push(j);}else this._pending.push(j);}.bind(this));i.forEach(function(j){this._attemptCallback(j.fn,j.resources);}.bind(this));},_attemptCallback:function(i,j){var h=this._constructCallbackArg(j,true);h&&i(h);return !!h;},_constructCallbackArg:function(l,h){var m={};for(var i=0;i<l.length;i++){var j=l[i];var k=this._resources[j];if(typeof k=='undefined'&&h)return false;m[j]=k;}return m;},_getUnavailableResources:function(h){return h.filter(function(i){return !this._resources[i];}.bind(this));}};e.exports=a;});
__d("TimestampConverter",["JSLogger"],function(f,h,i,g,e){var a=h('JSLogger');var d=a.create('timestamp_converter');function c(j){return (typeof(j)=='string')&&j.length>6;}var b={convertActionIDToTimestamp:function(j){if(c(j)){var k=j.slice(0,-6);return parseInt(k,10);}},maxValidActionID:function(j,k){if(!c(j))return k;if(!c(k))return j;return this.isGreaterThan(j,k)?j:k;},isGreaterThan:function(j,k){if(!c(j)||!c(k))return false;return this.convertActionIDToTimestamp(j)>this.convertActionIDToTimestamp(k);}};g.exports=b;});
__d("MercuryServerDispatcher",["copyProperties","AsyncRequest","FunctionUtils","URI","Dialog"],function(i,k,l,j,h){var g=k('copyProperties');var a=k('AsyncRequest');var c=k('FunctionUtils');var e=k('URI');var f={};var d={IMMEDIATE:'immediate',IDEMPOTENT:'idempotent',BATCH_SUCCESSIVE:'batch-successive',BATCH_DEFERRED_MULTI:'batch-deferred-multi',registerEndpoints:function(m){for(var o in m){var n=m[o];f[o]=new b(o,n);}},trySend:function(n,m){f[n].trySend(m);}};function b(o,n){var m=n.mode||d.IMMEDIATE;switch(m){case d.IMMEDIATE:case d.IDEMPOTENT:case d.BATCH_SUCCESSIVE:case d.BATCH_DEFERRED_MULTI:break;default:throw new Error('Invalid MercuryServerDispatcher mode '+m);}this._endpoint=o;this._mode=m;this._combineData=n.batch_function;this._handler=n.handler;this._errorHandler=n.error_handler;this._deferredSend=c.debounce(this._batchSend.bind(this),0,false);}b.prototype={_inFlight:0,_handler:null,_errorHandler:null,_combineData:null,trySend:function(m){if(typeof m=='undefined')m=null;var n=this._mode;if(n==d.IMMEDIATE){this._send(m);}else if(n==d.IDEMPOTENT){if(!this._inFlight)this._send(m);}else if(n==d.BATCH_SUCCESSIVE){if(!this._inFlight){this._send(m);}else this._batchData(m);}else if(n==d.BATCH_DEFERRED_MULTI){this._batchData(m);this._deferredSend();}},_send:function(m){this._inFlight++;new a(this._endpoint).setData(m).setHandler(this._handleResponse.bind(this)).setErrorHandler(this._handleError.bind(this)).setTransportErrorHandler(this._handleError.bind(this)).send();},_batchData:function(m){if(typeof this._batchedData=='undefined'){this._batchedData=m;}else this._batchedData=this._combineData(this._batchedData,m);},_batchSend:function(){if(typeof this._batchedData!='undefined'){this._send(this._batchedData);delete this._batchedData;}},_handleResponse:function(n){this._inFlight--;var m=n.getPayload();if(m&&m.error_payload){if(this._errorHandler)this._errorHandler(n);}else this._handler&&this._handler(m);if(this._mode==d.BATCH_SUCCESSIVE)this._batchSend();},_handleError:function(m){this._errorHandler&&this._errorHandler(m);this._inFlight--;}};j.exports=d;});
__d("MercuryThreadInformer",["Arbiter","copyProperties","MercuryAssert"],function(m,o,p,n,l){var a=o('Arbiter');var k=o('copyProperties');var b=o('MercuryAssert');var f={};var g=false;var j=false;var i=false;var e={};var d=0;function h(){if(!d)try{var changed_threads=keys(f);if(changed_threads.length||g)c.inform('threadlist-updated',changed_threads);if(changed_threads.length)c.inform('threads-updated',f);if(j)c.inform('unseen-updated',null);if(i)c.inform('unread-updated',null);var received_message_threads=keys(e);if(received_message_threads.length)c.inform('messages-received',e);}catch(q){throw q;}finally{f={};g=false;j=false;e={};}}var c=k(new a(),{updatedThread:function(q){f[q]=true;h();},updatedThreadlist:function(){g=true;h();},updatedUnseenState:function(){j=true;h();},updatedUnreadState:function(){i=true;h();},receivedMessage:function(q){b.isThreadID(q.thread_id);var r=q.thread_id;if(!e[r])e[r]=[];e[r].push(q);this.updatedThread(r);},synchronizeInforms:function(q){d++;try{q();}catch(r){throw r;}finally{d--;h();}},listen:function(r,q){return this.subscribe('threads-updated',function(t,s){if(s[r])q(r);});}});n.exports=c;});
__d("MercuryServerRequests",["Arbiter","CallbackManager","TimestampConverter","copyProperties","Env","JSLogger","MercuryAssert","ObjectUtils","MercuryServerDispatcher","MercuryThreadInformer","hasArrayNature","MercuryConstants"],function(zc,zf,zg,ze,zb){var a=zf('Arbiter');var b=zf('CallbackManager');var d=zf('TimestampConverter');var z=zf('copyProperties');var e=zf('Env');var f=zf('JSLogger');var g=zf('MercuryAssert');var h=zf('ObjectUtils');var i=zf('MercuryServerDispatcher');var k=zf('MercuryThreadInformer');var zd=zf('hasArrayNature');var c=zf('MercuryConstants');var t=0;var s=f.create('mercury_server');var v=new b();var m=new b();var x=[];var o={};function y(zh){t=d.maxValidActionID(t,zh);}function n(zk){var zj=zk.thread_id;var zh=v.getResource(zj);if(!zh){if(zk.is_canonical_user){var zi=zk.participants;if(zi.length==1){zh='user:'+e.user;}else zi.forEach(function(zm){var zl=w(zm);if(zl.type=='fbid'&&zl.value!=e.user)zh='user:'+zl.value;});}else if(zk.is_canonical_group){zh='group:'+zk.group_id;}else if(zk.root_message_threading_id)zh='root:'+zk.root_message_threading_id;zh=zh||'thread:'+zj;v.setResource(zj,zh);m.setResource(zh,zj);}zk.thread_id=zh;}function w(zi){var zh=zi.indexOf(':');if(zh<=0)throw new Error('Not a token',zi);return {type:zi.substr(0,zh),value:zi.substr(zh+1)};}function q(zk,zh){var zj=m.executeOrEnqueue(zk,zh);var zi=j.tokenizeThreadID(zk);if(zj.length&&zi.type!='root')j.fetchThreadData(zj);}function r(zh){return m.getResource(zh);}function p(zi){var zh=v.getResource(zi);if(typeof zh=='undefined')s.warn('no_client_thread_id',{server_id:zi});return zh;}function u(zh){(zh.threads||[]).forEach(function(zi){n(zi);delete o[zi.thread_id];y(zi.last_action_id);});(zh.ordered_threadlists||[]).forEach(function(zi){zi.thread_ids=zi.thread_ids.map(p);});if(x.length){zh.actions=x.concat(zh.actions?zh.actions:[]);x=[];}zh.actions=zh.actions||[];zh.actions.forEach(function(zi){if(zi.status&&zi.status!=c.MercuryActionStatus.SUCCESS&&!zi.thread_id){zi.thread_id=zi.client_thread_id;return;}if(zi.action_type==c.MercuryActionType.SEND_MESSAGE&&zi.client_thread_id){m.setResource(zi.client_thread_id,zi.thread_id);v.setResource(zi.thread_id,zi.client_thread_id);}zi.thread_id=p(zi.thread_id);y(zi.action_id);});if(zh.unseen_thread_ids)zh.unseen_thread_ids=zh.unseen_thread_ids.map(p);if(zh.unread_thread_ids)zh.unread_thread_ids=zh.unread_thread_ids.map(p);}function l(zj,zh){var zk=z({},zj);for(var zi in zh)if(zd(zk[zi])){zk[zi]=keys(h.createFrom(zk[zi].concat(zh[zi])));}else if(zk[zi]){zk[zi]=z(zk[zi],zh[zi]);}else zk[zi]=zh[zi];return zk;}var j=z(new a(),{tokenizeThreadID:function(zh){g.isThreadID(zh);return w(zh);},getServerThreadID:function(zi,zh){g.isThreadID(zi);q(zi,zh);},getClientThreadIDNow:function(zh){return v.getResource(zh);},canLinkExternally:function(zh){g.isThreadID(zh);var zi=j.tokenizeThreadID(zh);return (zi.type=='user')||!!r(zh);},fetchMissedMessages:function(){i.trySend('/mercury/ajax/thread_sync.php',{last_action_id:t});},fetchThreadData:function(zk){g.allThreadID(zk);var zi={};var zm=[];var zl=[];var zj=[];zk.forEach(function(zo){if(o[zo])return;o[zo]=true;var zn=j.tokenizeThreadID(zo);if(zn.type=='user'){zm.push(zn.value);zi.users=zm;}else if(zn.type=='group'){zj.push(zn.value);zi.groups=zj;}else if(zn.type=='thread'){zl.push(zn.value);zi.threads=zl;}else if(zn.type!='root')throw new Error('Unknown thread type',zn);});for(var zh in zi){i.trySend('/mercury/ajax/thread_info.php',zi);break;}},ensureThreadIsFetched:function(zh){if(!v.getResource(zh))i.trySend('/mercury/ajax/thread_info.php',{threads:[zh]});},fetchThreadMessages:function(zi,zh){g.isThreadID(zi);q(zi,function(zk){var zj={messages:{}};zj.messages[zk]=zh;i.trySend('/mercury/ajax/thread_info.php',zj);});},handleThreadInfoError:function(zk){var zi=zk.getRequest().getData();var zh=[];if(zi.messages){var zj=zi.messages;for(var zl in zj)zh.push({action_type:c.MercuryActionType.LOG_MESSAGE,thread_id:zl,message_id:zl,timestamp:1,timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:c.MercurySourceType.UNKNOWN,log_message_type:c.MercuryLogMessageType.SERVER_ERROR,log_message_data:{}});}if(zh.length)j.handleUpdate({actions:zh,payload_source:c.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});if((zi.users||zi.groups||zi.threads)&&!zi.is_retry){if(zi.messages)delete zi.messages;zi.is_retry=true;i.trySend('/mercury/ajax/thread_info.php',zi);}},changeThreadReadStatus:function(zj,zi){g.isThreadID(zj);q(zj,function(zl){var zk={ids:{}};zk.ids[zl]=zi;i.trySend('/mercury/ajax/change_read_status.php',zk);});var zh=[{action_type:c.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:zj,mark_as_read:zi}];this.handleUpdate({actions:zh,payload_source:c.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS},true);},_batchThreadRead:function(zj,zi){var zh={};z(zh,zj.ids);z(zh,zi.ids);return {ids:zh};},sendNewMessage:function(zi){var zh=j.tokenizeThreadID(zi.thread_id);var zj=z({},zi);if((zh.type=='root'&&zh.value==zj.message_id)||(zh.type=='user'&&!r(zi.thread_id))){zj.client_thread_id=zj.thread_id;zj.thread_id=null;this._sendNewMessageToServer(zj);}else q(zj.thread_id,function(zl){zj.thread_id=zl;j._sendNewMessageToServer(zj);});var zk={actions:[z({},zi)],payload_source:c.MercuryPayloadSource.CLIENT_SEND_MESSAGE};j.handleUpdate(zk,true);},_sendNewMessageToServer:function(zh){i.trySend('/mercury/ajax/send_messages.php',{message_batch:[zh]});},_batchMessageSend:function(zi,zh){return {message_batch:zi.message_batch.concat(zh.message_batch)};},requestMessageConfirmation:function(zm){var zh={};var zk={};for(var zo in zm){var zn=r(zo);if(zn){zh[zn]=zm[zo];}else{var zl=zm[zo];for(var zi=0;zi<zl.length;zi++)zk[zl[zi]]=zo;}}var zp=h.getKeys(zh);var zj=h.getKeys(zk);if(zp.length||zj.length)i.trySend('/mercury/ajax/confirm_messages.php',{thread_message_map:zh,local_messages:zk});},handleMessageConfirmError:function(zm){var zo=zm.getRequest().getData().thread_message_map;var zj=zm.getRequest().getData().local_messages;if(!zo&&!zj)return;var zh=[];for(var zn in zo){var zl=zo[zn];zl.forEach(function(zp){zh.push({action_type:c.MercuryActionType.SEND_MESSAGE,client_message_id:zp,message_id:zp,client_thread_id:null,thread_id:zn,status:c.MercuryActionStatus.UNABLE_TO_CONFIRM});});}for(var zk in zj){var zi=zj[zk];zh.push({action_type:c.MercuryActionType.SEND_MESSAGE,client_message_id:zk,message_id:zk,client_thread_id:zi,thread_id:null,status:c.MercuryActionStatus.UNABLE_TO_CONFIRM});}if(zh.length)this.handleUpdate({actions:zh,payload_source:c.MercuryPayloadSource.CLIENT_HANDLE_ERROR});},markSeen:function(){var zh=d.convertActionIDToTimestamp(t);i.trySend('/mercury/ajax/mark_seen.php',{seen_timestamp:zh});},_batchMarkSeen:function(zi,zh){return zh;},handleUpdate:function(zj,zi){s.debug('handle_update',{payload:zj,from_client:zi});for(var zh in zj){k.synchronizeInforms(function(){if(!zi)u(zj);this.inform('update-unread',zj);this.inform('update-participants',zj);this.inform('update-threads',zj);this.inform('update-threadlist',zj);this.inform('update-messages',zj);this.inform('update-unseen',zj);this.inform('model-update-completed',null);}.bind(this));break;}},handleSendMessageError:function(zl){var zj=zl.getPayload();var zk=zl.getRequest().getData();var zh=zk.message_batch;if(!zh)return;var zn;if(zj&&zj.error_payload){zn=c.MercuryActionStatus.UNCONFIRMED;}else zn=c.MercuryActionStatus.REQUEST_ERROR;var zm=zh.map(function(zo){return {action_type:c.MercuryActionType.SEND_MESSAGE,client_message_id:zo.message_id,message_id:zo.message_id,client_thread_id:zo.client_thread_id,thread_id:zo.thread_id,status:zn};});var zi={actions:zm,payload_source:c.MercuryPayloadSource.CLIENT_HANDLE_ERROR};this.handleUpdate(zi);},getLastActionID:function(){return t;},receivedMessage:function(zh){var zj=v.getResource(zh.thread_id);if(zj){j.handleUpdate({actions:[z({},zh)],payload_source:c.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});return;}var zi=v.executeOrEnqueue(zh.thread_id,function(zk){x.push(z({},zh));});i.trySend('/mercury/ajax/thread_info.php',{threads:zi});}});var za=j.handleUpdate.bind(j);i.registerEndpoints({'/mercury/ajax/thread_sync.php':{mode:i.IDEMPOTENT,handler:za},'/mercury/ajax/thread_info.php':{mode:i.BATCH_DEFERRED_MULTI,batch_function:l,handler:za,error_handler:j.handleThreadInfoError.bind(j)},'/mercury/ajax/change_read_status.php':{mode:i.BATCH_SUCCESSIVE,batch_function:j._batchThreadRead,handler:za},'/mercury/ajax/send_messages.php':{mode:i.BATCH_SUCCESSIVE,batch_function:j._batchMessageSend,handler:za,error_handler:j.handleSendMessageError.bind(j)},'/mercury/ajax/mark_seen.php':{mode:i.BATCH_SUCCESSIVE,batch_function:j._batchMarkSeen,handler:za},'/mercury/ajax/confirm_messages.php':{mode:i.IMMEDIATE,handler:za,error_handler:j.handleMessageConfirmError.bind(j)}});ze.exports=j;});
__d("MercuryThreads",["Arbiter","copyProperties","JSLogger","CallbackManager","TimestampConverter","MercuryAssert","MercuryServerRequests","MercuryThreadInformer","MercuryConstants","Env"],function(u,w,x,v,t){var a=w('Arbiter');var s=w('copyProperties');var e=w('JSLogger');var b=w('CallbackManager');var d=w('TimestampConverter');var f=w('MercuryAssert');var g=w('MercuryServerRequests');var h=w('MercuryThreadInformer');var c=w('MercuryConstants');var n=e.create('mercury_threads');var p=new b();function j(ze,zc,z){var zb=d.maxValidActionID(ze.action_id,z);if(!z||zb===z){var y=w('Env');var zd=Object.from(ze.participants,true);var za='fbid:'+y.user;zc.forEach(function(zf){if(zd[zf]!==true){ze.participants.push(zf);if(zf===za)ze.is_subscribed=true;}});}}function o(zc,zb,z){var za=d.maxValidActionID(zc.action_id,z);if(!z||za===z){var y=w('Env');zc.participants.remove(zb);if(zb==='fbid:'+y.user)zc.is_subscribed=false;}}function k(z,y){if(z.participants[0]!=y){z.participants.remove(y);z.participants.unshift(y);}}function r(z,y){z.snippet=y.body;z.snippet_has_attachment=y.has_attachment;z.snippet_attachments=y.attachments;z.is_forwarded_snippet=!!y.forward_count;}function l(za,z){if(!za)return false;var y=!za.unread_count;if(!za||z==y)return false;za.unread_count=z?0:1;p.setResource(za.thread_id,za);h.updatedThread(za.thread_id);return true;}function q(za,y){var zb=y.action_type;if(zb==c.MercuryActionType.USER_GENERATED_MESSAGE||zb==c.MercuryActionType.LOG_MESSAGE){y.is_unread&&za.unread_count++;za.is_archived=false;}switch(zb){case c.MercuryActionType.USER_GENERATED_MESSAGE:k(za,y.author);break;case c.MercuryActionType.LOG_MESSAGE:var z=y.log_message_type;if(z==c.MercuryLogMessageType.SUBSCRIBE){j(za,y.log_message_data.added_participants,y.action_id);}else if(z==c.MercuryLogMessageType.UNSUBSCRIBE)o(za,y.author,y.action_id);break;case c.MercuryActionType.CHANGE_READ_STATUS:l(za,y.mark_as_read);break;}za.last_action_id=d.maxValidActionID(y.action_id,za.last_action_id);}function m(z){var y=g.tokenizeThreadID(z.thread_id);if(y.type=='group'){n.error('invalid_new_thread_message',z);return undefined;}var za={thread_id:z.thread_id,last_action_id:z.action_id,participants:z.specific_to_list,name:null,snippet:z.body,snippet_has_attachment:false,snippet_attachments:[],unread_count:0,image_src:null,timestamp_absolute:z.timestamp_absolute,timestamp_relative:z.timestamp_relative,timestamp:z.timestamp,is_canonical_user:y.type=='user',is_subscribed:true,is_canonical_group:false,group_id:null,root_message_threading_id:z.message_id,folder:c.MessagingTag.INBOX,is_archived:false};p.setResource(za.thread_id,za);return za;}a.subscribe(e.DUMP_EVENT,function(z,y){y.messaging=y.messaging||{};y.messaging.threads=p.dumpResources();});var i={getThreadMetaNow:function(y){f.isThreadID(y);return p.getResource(y);},getThreadMeta:function(zb,y){f.isThreadID(zb);var z=p.executeOrEnqueue(zb,y);if(!z.length)return;var za=g.tokenizeThreadID(zb);if(za.type=='user'){this.getCanonicalThreadToUser(za.value);}else g.fetchThreadData(z);},changeThreadReadStatus:function(za,y){f.isThreadID(za);var z=p.getResource(za);if(l(z,y))g.changeThreadReadStatus(za,y);},updateThreads:function(z){if(!z||!z.length)return;var y={};z.forEach(function(za){y[za.thread_id]=za;});p.addResourcesAndExecute(y);},updateMetadataByActions:function(z){if(!z||!z.length)return;var zh={};var zg={};var zi={};for(var zb=0;zb<z.length;zb++){var y=z[zb];var zk=y.action_type;var zj=y.thread_id;f.isThreadID(zj);var zf=this.getThreadMetaNow(zj);if(zk==c.MercuryActionType.LOG_MESSAGE&&y.log_message_type==c.MercuryLogMessageType.SERVER_ERROR)continue;if(!zf&&!y.action_id&&zk==c.MercuryActionType.USER_GENERATED_MESSAGE)zf=m(y);if(zf){if(!zi[zj])zi[zj]=s({},zf);if(y.timestamp<=zf.timestamp&&y.action_id)continue;q(zi[zj],y);if(zk==c.MercuryActionType.USER_GENERATED_MESSAGE)zh[zj]=y;if(zk==c.MercuryActionType.USER_GENERATED_MESSAGE||zk==c.MercuryActionType.LOG_MESSAGE||zk==c.MercuryActionType.SEND_MESSAGE)if(y&&(!zg[zj]||y.timestamp>zg[zj].timestamp))zg[zj]=y;}}for(var ze in zi){var za=zi[ze];var zd=zh[ze];if(zd)r(za,zd);var zc=zg[ze];if(zc)za=s(za,{timestamp_absolute:zc.timestamp_absolute,timestamp_relative:zc.timestamp_relative,timestamp:zc.timestamp});p.setResource(ze,za);}},getCanonicalThreadToGroup:function(z,y){var za='group:'+z;this.getThreadMeta(za,y);},getCanonicalThreadToUser:function(zb){var za='user:'+zb;var z=p.getResource(za);if(typeof z=='undefined'){var y=w('Env');z=i.createNewLocalThread(za,['fbid:'+y.user,'fbid:'+zb]);g.fetchThreadData([za]);}return z;},createNewLocalThread:function(zb,z){var za=p.getResource(zb);if(!za){var y=g.tokenizeThreadID(zb);za={thread_id:zb,last_action_id:null,participants:z,name:null,snippet:'',snippet_has_attachment:false,unread_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,is_canonical_user:y.type=='user',is_subscribed:true,is_canonical_group:y.type=='group',group_id:null,root_message_threading_id:null,folder:c.MessagingTag.INBOX,is_archived:false};p.setResource(zb,za);}return za;},addParticipantsToThreadLocally:function(za,y){var z=p.getResource(za);if(z){j(z,y,null);h.updatedThread(z.thread_id);}},getCanonicalUserInThread:function(z){var y=g.tokenizeThreadID(z);return y.type=='user'?y.value:null;},getCanonicalGroupInThread:function(z){var y=g.tokenizeThreadID(z);return y.type=='group'?y.value:null;},isEmptyLocalThread:function(za){var z=p.getResource(za);if(!z)return false;var y=g.tokenizeThreadID(za);return y.type=='root'&&!z.timestamp;}};g.subscribe('update-threads',function(y,z){i.updateMetadataByActions(z.actions);i.updateThreads(z.threads);(z.threads||[]).each(function(za){h.updatedThread(za.thread_id);});});v.exports=i;});
__d("ChatTabModel",["Arbiter","ArrayUtils","copyProperties","JSLogger","math-extensions","MercuryAssert","MercuryThreads","MercuryServerRequests","PresenceState","ObjectUtils"],function(ze,zg,zh,zf,zd){var a=zg('Arbiter');var b=zg('ArrayUtils');var zc=zg('copyProperties');var c=zg('JSLogger');var d=zg('math-extensions');var e=zg('MercuryAssert');var g=zg('MercuryThreads');var f=zg('MercuryServerRequests');var i=zg('PresenceState');var h=zg('ObjectUtils');var za=[];var x=null;var o=0;var s=20;var n=c.create('chat_tab_model');var y=false;function z(zi){zi.t2=[];zi.uct2=o;zi.lm2=x;za.forEach(function(zk){if(!zk.fragile){var zj={i:zk.id,si:zk.server_id};if(zk.raised)zj.r=1;zi.t2.push(zj);}});return zi;}function p(zj){if(zj&&zj.t2){var zk=d.verifyNumber(zj.uct2);if(zk>o){o=zk;n.log('load_cookie_tabs',{tabs:zj.t2,promoted:zj.lm2});var zi=zj.t2;q(zi,zj.lm2||null);}}}function q(zj,zi){if(zb(zj,zi)){za=zj.map(function(zl){var zk={id:zl.i,server_id:zl.si};if(zl.r)zk.raised=true;if(zk.id==zi)x=zk.id;return zk;});l();t();}}function zb(zl,zk){if(zk!=x)return true;if(zl.length!=za.length)return true;for(var zi=0,zj=zl.length;zi<zj;zi++)if(!h.areEqual(zl[zi],za[zi]))return true;return false;}function t(){if(y)ChatTabModel.inform('chat/tabs-changed',ChatTabModel.get());}function k(){o=Math.floor(Date.now()*.001);i.doSync();t();}function l(){var zi=za.length-s;if(zi>0)za=za.filter(function(zj){return zj.raised||zi--<=0;});}function m(zj){for(var zi=0;zi<za.length;zi++)if(za[zi].id==zj)return zi;return -1;}function w(zj){var zk=g.getThreadMetaNow(zj);if(!zk)return false;if(zk.is_canonical){return v(zj);}else{var zi=u(zj);if(zi)f.getServerThreadID(zj,function(zl){if(r(zj,zl))k();});return zi;}}function u(zi){if(m(zi)===-1){za.push({id:zi,fragile:true});return true;}return false;}function v(zj){var zk=m(zj);if(zk!=-1)if(za[zk].fragile){za.splice(zk,1);}else return false;for(var zi=0;zi<=za.length;zi++)if(zi==za.length||za[zi].fragile){za.splice(zi,0,{id:zj});l();return true;}}function r(zi,zk){var zj=m(zi);if(zj!=-1&&za[zj].fragile){za[zj].fragile=false;za[zj].server_id=zk;return true;}return false;}function j(zi){var zj=m(zi);if(zj!=-1){za.splice(zj,1);return true;}return false;}i.registerStateStorer(z);i.registerStateLoader(p);zf.exports=ChatTabModel=zc(new a(),{indexOf:function(zi){return m(zi);},closeAllTabs:function(){if(za.length){za=[];x=null;k();}},closeFragileTabs:function(){for(var zi=0;zi<za.length;zi++)if(za[zi].fragile){za.splice(zi);t();break;}},closeTab:function(zi){e.isThreadID(zi);if(j(zi)){if(x==zi)x=null;k();}},raiseTab:function(zj){e.isThreadID(zj);var zi=w(zj);var zk=m(zj);if(!za[zk].raised){za[zk].raised=true;k();}},get:function(){var zi=za.map(function(zj){var zk=zc({},zj);delete zk.fragile;return zk;});return {tabs:zi,promoted:x};},openFragileTab:function(zi){e.isThreadID(zi);if(u(zi))t();},openTab:function(zi){e.isThreadID(zi);if(w(zi))k();},lowerTab:function(zi){e.isThreadID(zi);var zj=m(zi);if(zj!=-1&&za[zj].raised){delete za[zj].raised;k();}},raiseAndPromoteTab:function(zi){e.isThreadID(zi);w(zi);var zj=m(zi);if(!za[zj].raised||x!=zi){za[zj].raised=true;x=zi;k();}}});a.subscribe(c.DUMP_EVENT,function(zj,zi){zi.chat_tabs={promoted:x,tabs:za.map(function(zk){return zc({},zk);}),time:o};});p(i.getInitial(),true);y=true;});
__d("ChatController",["ChatTabModel","MercuryThreads"],function(d,f,g,e,c){var a=f('ChatTabModel');var b=f('MercuryThreads');e.exports={raiseFragileGroupTab:function(h){b.getCanonicalThreadToGroup(h,function(i){a.openFragileTab(i.thread_id);});},raiseGroupTab:function(h){b.getCanonicalThreadToGroup(h,function(i){a.raiseTab(i.thread_id);});}};});
__d("MercuryRequireEnsure",[],function(b,d,e,c,a){c.exports.ensure=function(g,h,f){e(g,h,f);};});