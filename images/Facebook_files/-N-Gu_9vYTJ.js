/*1327103910,176832695*/

if (window.CavalryLogger) { CavalryLogger.start_js(["1uMAe"]); }

function CIWebmailBootloader(a,b){this.controllerFn=b;var c=Event.listen(a,'mouseover',function(){c.remove();this.bootload();}.bind(this));return this;}copy_properties(CIWebmailBootloader.prototype,{bootload:function(a){Bootloader.loadComponents('contact-importer-webmail',function(){this.controller=this.controller||this.controllerFn();if(a)this.controller.onSubmit();}.bind(this));},onSubmit:function(){if(this.controller){this.controller.onSubmit();}else this.bootload(true);}});
function PhotoTagApproval(b){this.units=[];this.currentUnit=0;this._version=b;var a;if(b==PhotosConst.VIEWER_SNOWBOX){a=PhotoSnowbox.DATA_CHANGE;this._root=ge('fbPhotoSnowboxTagApproval');}else{a=PhotoPermalink.DATA_CHANGE;this._root=ge('fbPhotoPageTagApproval');}Arbiter.subscribe(a,this.restartTagApproval.bind(this));Event.listen(this._root,'click',this.handleClick.bind(this));Event.listen(this._root,'mousemove',function(c){this.hiliteCurrentPendingTag();Event.kill(c);}.bind(this));this.restartTagApproval();}PhotoTagApproval.prototype={handleClick:function(event){var c=event.getTarget();if(CSS.hasClass(c,'nextPager')&&CSS.hasClass(c,'enabled')){this.showNextUnit();}else if(CSS.hasClass(c,'prevPager')&&CSS.hasClass(c,'enabled')){this.showPrevUnit();}else if(Parent.byClass(c,'fbPhotoApprovalPendingButtons')){unit=this.units[this.currentUnit];var b=this.getTagNameID(unit);if(b){var a=Parent.byClass(c,'approve');Arbiter.inform('PhotoTagApproval.UPDATE_TAG_BOX',{id:b,approve:a,version:this._version});}this.removeSelectedUnit();}return true;},loadUnits:function(a){this.units=DOM.scry(this._root,'div.fbPhotoApprovalUnit');if(this.units.length){CSS.show(this._root);this.showUnit(a);CSS.conditionClass(this._root,'hidePagers',this.units.length==1);}else{CSS.hide(this._root);Arbiter.inform('PhotoTagApproval.HILITE_TAG',{tag:null,version:this._version});}},restartTagApproval:function(){this.loadUnits(0);},removeSelectedUnit:function(){var a=this.units[this.currentUnit];DOM.remove(a);this.loadUnits(this.currentUnit);},showNextUnit:function(){this.showUnit(this.currentUnit+1);},showPrevUnit:function(){this.showUnit(this.currentUnit-1);},getTagNameID:function(b){var a=b.id.indexOf(':');return b.id.slice(a+1);},showUnit:function(a){this.units.each(CSS.hide);this.currentUnit=(a+this.units.length)%this.units.length;var b=this.units[this.currentUnit];CSS.show(b);this.hiliteCurrentPendingTag();CSS.conditionClass(DOM.find(this._root,'a.prevPager'),'enabled',this.currentUnit>0);CSS.conditionClass(DOM.find(this._root,'a.nextPager'),'enabled',this.currentUnit<this.units.length-1);},hiliteCurrentPendingTag:function(){var b=this.units[this.currentUnit];var a=this.getTagNameID(b);Arbiter.inform('PhotoTagApproval.HILITE_TAG',{tag:a,version:this._version});}};
var PhotoPermalink={PAGE:'PhotoPermalink.PAGE',DATA_CHANGE:'PhotoPermalink.DATA_CHANGE',STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_DATA:'image',MIN_TAG_DISTANCE:80,init:function(){this.stream=new PhotoStreamCache();this.stream.init(PhotosConst.VIEWER_PERMALINK);this.reset();this.root=$('fbPhotoPageContainer');this.header=$('fbPhotoPageHeader');this.stageWrapper=ge('photoborder');this.videoStage=DOM.find(this.stageWrapper,'div.videoStage');this.buttonActions=DOM.find(this.root,'div.stageButtons');this.feedback=ge('fbPhotoPageFeedback');this.image=ge('fbPhotoImage');this.errorBox=ge('fbPhotoPageError');this.actionList=ge('fbPhotoPageActions');this.loadingStates={image:false,html:false};this.unhiliteTimer=null;var a={mouseout:this.mouseOutListener.bind(this),mousemove:this.mouseMoveListener.bind(this)};this.pageHandlers=values(Event.listen(this.root,a));this.pageHandlers.push(Event.listen(this.stageWrapper,'click',this.stageClickListener.bind(this)),Event.listen(this.stageWrapper,'dragstart',this.killDrag.bind(this)),Event.listen(this.stageWrapper,'selectstart',this.killDrag.bind(this)),Event.listen(this.buttonActions,'click',this.buttonListener.bind(this)),Event.listen(this.actionList,'click',this.rotateListener.bind(this)),Event.listen(this.feedback,'click',function(event){if(Parent.byClass(event.getTarget(),'like_link'))CSS.toggleClass(DOM.find(this.buttonActions,'div.likeCommentGroup'),'viewerLikesThis');}.bind(this)));PageTransitions.registerHandler(this.transitionHandler.bind(this));KeyEventController.registerKey('LEFT',this.goNav.bind(this,'prev'));KeyEventController.registerKey('RIGHT',this.goNav.bind(this,'next'));PhotoSessionLog.initLogging(PhotoSessionLog.PERMALINK);Arbiter.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));Arbiter.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));},getRoot:function(){return this.root;},updateTags:function(a){this.saveTagsFromPayload(a.getPayload());},saveTagsFromPayload:function(a){this.storeFromData(a);if('data' in a&&this.stream.getCursor() in a.data)this.swapData();},goNav:function(c,event){var a=Event.getKeyCode(event)||event.getTarget();if(this.theaterModeOn())return true;var b=Parent.byClass(a,'stageWrapper')&&!Parent.byClass(a,'tagBoxPending')&&!Parent.byClass(a,'tagBoxPendingResponse');if(b&&CSS.hasClass(this.root,'taggingMode'))return false;if(a==KEYS.LEFT||(b&&c=='prev')){this.page(-1);}else if(a==KEYS.RIGHT||(b&&c=='next'))this.page(1);return false;},theaterModeOn:function(){return CSS.hasClass(document.documentElement,'theaterMode');},pagerClick:function(a){if(this.theaterModeOn())return true;if(a=='prev'){this.page(-1);}else if(a=='next')this.page(1);return false;},setLoadingState:function(b,a){switch(b){case PhotoPermalink.STATE_IMAGE_DATA:this.loadingStates[b]=a;CSS.conditionClass(this.root,'imageLoading',a);break;case PhotoPermalink.STATE_HTML:this.loadingStates[b]=a;CSS.conditionClass(this.root,'dataLoading',a);break;}},checkState:function(b){if(b!=PhotoPermalink.STATE_ERROR&&!this.loadingStates[b])return;switch(b){case PhotoPermalink.STATE_IMAGE_DATA:var a=this.stream.getCurrentImageData();if(a){if(a.url){this.switchImage(a.url,true);}else if(a.video)this.switchVideo(a.video,true);this.setLoadingState(b,false);}break;case PhotoPermalink.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(b,false);}break;default:if(this.stream.errorInCurrent()){CSS.hide(this.image);CSS.show(this.errorBox);}break;}},reHilitePendingTag:function(){var a=ge(this.hilitedTag);if(a&&CSS.hasClass(a,'showPendingTagName'))return;var b=DOM.scry(this.root,'div.tagsWrapper div.showPendingTagName')[0];if(b)this.switchHilitedTags(b.id);},page:function(b){if(!this.stream.isValidMovement(b))return;this.unhiliteAllTags();var c=this.getVideoOnStage();if(c)this.switchVideo(c,false);Arbiter.inform(PhotoPermalink.PAGE);this.recacheData();this.stream.moveCursor(b);CSS.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(PhotoPermalink.STATE_HTML,true);CSS.show(this.errorBox);}else{var a=this.stream.getCurrentImageData();if(a){if(a.url){this.switchImage(a.url,true);}else if(a.video)this.switchVideo(a.video,true);goURI(a.info.permalink);}else{this.waitForLoadCount++;this.setLoadingState(PhotoPermalink.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(PhotoPermalink.STATE_HTML,true);}},transitionHandler:function(a){if(a.getPath()=='/photo.php')if(a.getQueryData().permPage){PageTransitions.transitionComplete();return true;}else if(!this.theaterModeOn()&&a.getQueryData().makeprofile&&a.getQueryData().fbid==this.stream.getCursor()&&!this.getVideoOnStage()){Bootloader.loadComponents(['photocrop2'],PhotoCropper.start.bind(PhotoCropper));PageTransitions.transitionComplete();return true;}},recacheData:function(c){if(!this.loadingStates.html){var a=this.stream.getCurrentHtml();for(var b in a){a[b]=$A($(b).childNodes);if(c!==true&&b!=='fbPhotoPageHeader')DOM.empty($(b));}}},getCurrentPhotoInfo:function(){var a=this.stream.getCurrentImageData();return a&&a.info;},getVideoOnStage:function(){var a=this.stream.getCurrentImageData();return a&&a.video;},switchImage:function(d,c){CSS.hide(this.image);CSS.hide(this.errorBox);var a=this.stream&&this.stream.getCurrentImageData();if(a)PhotoSessionLog.addPhotoView(a.info);var b=$N('img',{id:'fbPhotoImage',className:'fbPhotoImage',alt:'',src:d});DOM.replace(this.image,b);this.image=b;if(c)this.stream.preloadImages();},switchVideo:function(c,a){var b='swf_'+c;if(a){CSS.addClass(this.stageWrapper,'showVideo');this.videoStage.id=c;if(window[b]&&!ge(b))window[b].write(c);}else{this.videoStage.id='fbPageVideoStage';window[b].addVariable('video_autoplay',0);DOM.empty(this.videoStage);CSS.removeClass(this.stageWrapper,'showVideo');}},swapData:function(){if(this.dataLoadTimer){this.setLoadingState(PhotoPermalink.STATE_HTML,true);clearTimeout(this.dataLoadTimer);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,true),100);return;}var b,c=this.stream.getCurrentHtml();if(c){for(var d in c){b=ge(d);b&&DOM.setContent(b,c[d]);}var a=DOM.scry($('fbPhotoPageCaption'),'div.fbPhotoInlineCaptionEditor');if(a.length)new PhotoInlineCaptionEditor('permalink').init(a[0]);Arbiter.inform(PhotoPermalink.DATA_CHANGE,this.stream.getCurrentImageData().info,Arbiter.BEHAVIOR_STATE);this.position=this.stream.getCursor();this.setLoadingState(PhotoPermalink.STATE_HTML,false);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,false),100);}this.adjustForNewData();},clearTimer:function(a){this.dataLoadTimer=false;a&&this.swapData();},adjustForNewData:function(){if(!this.image)return;var c=DOM.scry(this.stage,'div.tagsWrapper')[0];var a=Vector2.getElementDimensions(this.image);if(c){CSS.setStyle(c,'width',a.x+'px');CSS.setStyle(c,'height',a.y+'px');if(ua.ie()<=7){var b=DOM.scry(this.root,'div.tagContainer')[0];if(b)CSS.conditionClass(c,'ie7VerticalFix',Vector2.getElementDimensions(b).y>a.y);}}},fetchInitBucket:function(a){if(!this.stream.isLoaded())return;this.stream.fetch(a,true);},addPhotoFbids:function(b,c,a){var d=this.stream.getCursor()===null;this.stream.attachToFbidsList(b,c,a);if(a&&d)this.page(0);},storeFromResponse:function(a){this.storeFromData(a.getPayload());},storeFromData:function(a){var b=this.stream.storeToCache(a);if('init' in a){PhotoSessionLog.setPhotoSet(this.stream.getPhotoSet());PhotoSessionLog.setLogFbids(true);PhotoSessionLog.addPhotoView(this.stream.getCurrentImageData().info);}if('error' in b){this.checkState(PhotoPermalink.STATE_ERROR);return;}if('image' in b)this.checkState(PhotoPermalink.STATE_IMAGE_DATA);if('data' in b)this.checkState(PhotoPermalink.STATE_HTML);},setErrorBoxContent:function(a){DOM.setContent(this.errorBox,a);},updateTotalCount:function(c,b,a){element=ge('fbPhotoPagePositionAndCount');element&&DOM.setContent(element,a);this.stream.setTotalCount(c);this.stream.setFirstCursorIndex(b);},buttonListener:function(event){var a=event.getTarget();if(Parent.byClass(a,'likeButton')){DOM.find($('fbPhotoPageFeedback'),'button.like_link').click();}else if(Parent.byClass(a,'commentButton')){DOM.find(this.root,'div.commentBox textarea').focus();this.root.scrollTop=this.root.scrollHeight;}},rotateListener:function(event){var a=event.getTarget();if(Parent.byClass(a,'rotateRight')){this.rotate('right');}else if(Parent.byClass(a,'rotateLeft'))this.rotate('left');},stageClickListener:function(event){var a=event.getTarget();if(Parent.byClass(a,'fbPhotoTagApprovalBox')){return true;}else if(Parent.byClass(a,'videoStage')){return true;}else this.goNav('next',event);},rotate:function(c){var d=this.stream.getCursor();if(this.getVideoOnStage()){var b=(c=='left')?270:90;Bootloader.loadComponents(['video-rotate-viewer'],new VideoRotate(d,this.actionList).motionRotate(b));return;}var a={fbid:d,cs_ver:PhotosConst.VIEWER_PERMALINK,set:this.stream.getPhotoSet()};a[c]=1;this.setLoadingState(PhotoPermalink.STATE_IMAGE_DATA,true);CSS.hide(this.image);new AsyncRequest('/ajax/photos/photo/rotate/').setMethod('POST').setAllowCrossPageTransition(true).setReadOnly(false).setData(a).setHandler(this.storeResponseForRotate.bind(this,d)).send();},storeResponseForRotate:function(a,c){this.storeFromResponse(c);var b=this.stream.getImageData(a);b.url=c.getPayload().new_urls[PhotosConst.SIZE_NORMAL];b.dimensions=Vector2.deserialize(c.getPayload().dimensions);if(a==this.stream.getCursor()){this.setLoadingState(PhotoPermalink.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);this.swapData();}},mouseOutListener:function(event){var d=event.getTarget();var a=event.getRelatedTarget();var b=Parent.byClass(d,'stageActions');var c=Parent.byClass(d,'stageWrapper');var e=Parent.byClass(a,'stageActions');var f=Parent.byClass(a,'stageWrapper');var g=(!f&&(c&&!e)||(b&&!f));if(g)this.unhiliteAllTags(true);},mouseMoveListener:function(event){var a=event.getTarget();if(!Parent.byClass(a,'stageActions')&&!Parent.byClass(a,'stageWrapper'))return;this.hiliteTagsOnMouseMove(event);},unhiliteAllTags:function(a,event){DOM.scry(this.stageWrapper,'div.tagsWrapper div.hover').each(function(b){if(a&&CSS.hasClass(b,'tagBoxPending'))return;CSS.removeClass(b,'hover');});if(a)return;if(this.unhiliteTimer!==null){clearTimeout(this.unhiliteTimer);this.unhiliteTimer=null;}this.hilitedTag=null;},switchHilitedTags:function(b,c){this.unhiliteAllTags();var a=ge(b);if(a){this.hilitedTag=b;CSS.addClass(a,'hover');if(CSS.hasClass(a,'tagBoxPending')&&!CSS.hasClass(a,'showPendingTagName')&&c===true){DOM.scry(this.stageWrapper,'div.tagsWrapper div.showPendingTagName').each(function(d){CSS.removeClass(d,'showPendingTagName');});CSS.addClass(a,'showPendingTagName');}}},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.unhiliteTimer!==null)return;var m=event.getTarget();if(Parent.byClass(m,'fbPhotoPageTagApproval'))return;var j=Parent.byClass(m,'tagBoxPending');var d=(this.hilitedTag&&CSS.hasClass($(this.hilitedTag),'tagBoxPending'));var k=((!this.hilitedTag&&j)||(!d&&j));if(k){this.switchHilitedTags(j.id);return;}if(j&&(j.id==this.hilitedTag))return;var a=250;var e=ge('fbPhotoImage');var i=Vector2.getEventPosition(event);var g=Vector2.getElementPosition(e);var f=Vector2.getElementDimensions(e);var l=this.stream.getCurrentExtraData().tagRects;var h=PhotosUtils.getNearestBox(i,g,f,1,PhotoPermalink.MIN_TAG_DISTANCE,l);if(!h){if(!d){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var b=null;if(d){var c={};c[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];b=PhotosUtils.getNearestBox(i,g,f,1,PhotoPermalink.MIN_TAG_DISTANCE,c);}if(b!==null&&d)return;if(this.hilitedTag!=h)if(d){this.unhiliteTimer=this.unhiliteAllTags.bind(this,false,event).defer(a);}else this.switchHilitedTags(h);},updateTagBox:function(b,a){this.unhiliteAllTags();var c=ge(b);if(!c)return;CSS.addClass(c,'tagBox');CSS.addClass(c,'tagBoxPendingResponse');CSS.removeClass(c,'tagBoxPending');CSS.hide(DOM.find(c,'span.tagForm'));if(a){CSS.show(DOM.find(c,'span.tagApproved'));}else CSS.show(DOM.find(c,'span.tagIgnored'));},killDrag:function(){if(CSS.hasClass(this.root,'taggingMode'))return false;},reset:function(){if(this.pageHandlers){this.pageHandlers.each(function(a){a.remove();});this.pageHandlers=null;}KeyEventController.getInstance().resetHandlers();},onHiliteTag:function(a,b){if(b.version!=PhotosConst.VIEWER_PERMALINK)return;id=b.tag;if(id){this.switchHilitedTags(id,true);}else this.unhiliteAllTags();},onUpdateTagBox:function(a,b){if(b.version==PhotosConst.VIEWER_PERMALINK)this.updateTagBox(b.id,b.approve);}};
var PhotoCropper={init:function(c,b){if(this.photocrop)this.destroy();this.root=c;this.options=b||{};this.actionLinks=DOM.find(this.root,'div.fbPhotosPhotoActions');var a=DOM.scry(this.actionLinks,'a.fbPhotoActionsCrop');if(a.length===0)return;var d=this.start.bind(this);var e=DOM.find(a[0],'.startCropping');Event.listen(e,'click',function(){Bootloader.loadComponents('photocrop2',d);return false;});Arbiter.subscribe(PhotoPermalink.PAGE,this.destroy.bind(this),Arbiter.SUBSCRIBE_NEW);},start:function(){if(this.photocrop)return;this.cropLink=DOM.find(this.actionLinks,'a.fbPhotoActionsCrop');CSS.addClass(this.cropLink,'croppingModeOn');if(CSS.hasClass(this.cropLink,'profileAlbum')){this.reuseProfilePic.bind(this).defer();return false;}CSS.addClass(this.root,'croppingMode');var e=DOM.find(this.root,'img.fbPhotoImage');var c=DOM.find(this.root,'a.doneCroppingLink');var a=DOM.find(this.root,'a.cancelCroppingLink');var b=DOM.find(this.cropLink,'.doneCropping');this.wrapper=$N('div');CSS.addClass(this.wrapper,'stageCropper');DOM.find(this.root,'.stageWrapper').appendChild(this.wrapper);this.wrapper.style.marginTop=e.parentNode.style.marginTop;Event.listen(this.wrapper,'click',this.cancelAndStopEvent.bind(this));Event.listen(c,'click',this.done.bind(this));Event.listen(a,'click',this.cancelAndStopEvent.bind(this));Event.listen(b,'click',this.done.bind(this));var d={target:this.wrapper,min_width:this.options.min_width};var f=(function(){this.photocrop=new Photocrop(e,d);}).bind(this);if(e.complete){f();}else Event.listen(e,'load',f);return false;},done:function(){var b=PhotoPermalink.getCurrentPhotoInfo();var d=this.getProfilePicTarget(b).id;var a=this.destroy();var c=copy_properties({pid:b.pid,owner:b.owner,id:d,'return':'profile.php?id='+d,error_return:'photo.php?pid='+b.pid+'&id='+b.owner},a);Form.post('/crop_profile_pic.php',c);return false;},cancelAndStopEvent:function(){this.destroy();return false;},destroy:function(){if(this.photocrop){CSS.removeClass(this.cropLink,'croppingModeOn');CSS.removeClass(this.root,'croppingMode');DOM.remove(this.wrapper);var a=this.photocrop.done();this.photocrop=null;return a;}},reuseProfilePic:function(){var a=PhotoPermalink.getCurrentPhotoInfo();var c=this.getProfilePicTarget(a);var b=copy_properties({pid:a.pid,owner:a.owner,id:c.id,type:c.type,profile_pic_id:c.id});Form.post('/pic_upload.php',b);return false;},getProfilePicTarget:function(a){if(CSS.hasClass(this.cropLink,'makePageProfile'))return {id:a.owner,type:'object'};return {id:this.options.uid,type:'profile'};}};
function PhotoPermalinkTagger(b,a){this.parent.construct(this,b);this.photoData=a;}Class.extend(PhotoPermalinkTagger,'PhotoTagger');copy_properties(PhotoPermalinkTagger.prototype,{elemNames:{0:{tagger:'div.photoPermalinkTagger',addTagLink:'div.fbPhotosPhotoActions',overlayActions:'div.fbPhotosPhotoButtons',tagboxContainer:'fbPhotoPageTagBoxes',tagAction:'fbPhotosPhotoActionsTag',image:'img#fbPhotoImage'}},userActionData:{action:'tagging',namespace:'photo_permalink'},setupHandlers:function(){var b=$('imagestage');var a=$('fbPhotoPageTagBoxes');this.handlers=[Event.listen(this.clickState,'click',this.addTag.bind(this)),Event.listen(b,'click',this.addTag.bind(this)),Event.listen(a,'click',this.addTag.bind(this)),Event.listen(this.addTagLink,'click',this.checkActions.bind(this)),Event.listen(this.overlayActions,'click',this.checkActions.bind(this))];this.subscriptions=[Arbiter.subscribe(PhotoPermalink.PAGE,this.restartTagging.bind(this)),Arbiter.subscribe(PhotoPermalink.DATA_CHANGE,this.setPhotoData.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));},getTaggingSource:function(){return 'permalink';},getPosition:function(){return this.photoData.fbid;},getPhotoViewerObj:function(){return window.PhotoPermalink;},tagsChangeHandler:function(b){var a=this.getPhotoViewerObj();a&&a.updateTags(b);},setDataForTokenizer:function(){this.tokenizer.setup(null,this.photoData);return this;}});
function Photocrop(b,a){this.photo=b;copy_properties(this,copy_properties({target:this.photo.parentNode,width:200,height:200,min_width:100,min_height:100,center_x:(this.photo.offsetWidth||200)/2,center_y:(this.photo.offsetHeight||200)/2},a));var c=this.center_x-this.width/2;var d=this.center_y-this.height/2;this.box=[d,c+this.width,d+this.height,c];CSS.addClass(this.target,'photocrop');['bg','wrapper','viewport'].each(function(e){this[e]=$N('div');CSS.addClass(this[e],e);}.bind(this));this.highlight=$N('img',{src:b.src});CSS.addClass(this.highlight,'highlight');this.target.appendChild(this.bg);this.target.appendChild(this.wrapper);this.wrapper.appendChild(this.highlight);this.wrapper.appendChild(this.viewport);['ne','nw','sw','se'].each(function(e){var f=$N('div');CSS.addClass(f,e);this.viewport.appendChild(f);}.bind(this));Event.listen(this.viewport,{mousedown:this.mousedown.bind(this),dragstart:Event.kill,selectstart:Event.kill,click:Event.stop});Event.listen(document,{mousemove:this.mousemove.bind(this),mouseup:this.mouseup.bind(this)});[this.bg,this.wrapper].each(function(e){e.style.width=b.offsetWidth+'px';e.style.height=b.offsetHeight+'px';e.style.top=b.offsetTop+'px';e.style.left=b.offsetLeft+'px';});this.redraw();}Photocrop.prototype.redraw=function(){this.highlight.style.clip="rect("+this.box.join("px ")+"px)";this.viewport.style.top=this.box[0]+"px";this.viewport.style.left=this.box[3]+"px";this.viewport.style.height=(this.box[2]-this.box[0])+"px";this.viewport.style.width=(this.box[1]-this.box[3])+"px";};Photocrop.prototype.done=function(){[this.bg,this.wrapper].each(DOM.remove);CSS.removeClass(this.target,'photocrop');var a=this.box.map(Math.round);return {x:Math.max(a[3],0),y:Math.max(a[0],0),width:a[1]-Math.max(a[3],0),height:a[2]-Math.max(a[0],0)};};Photocrop.prototype.mousedown=function(a){this.mouseTarget=a.getTarget();this.pos=Vector2.getEventPosition(a);CSS.addClass(document.body,'draggingMode');return false;};Photocrop.prototype.mousemove=function(d){if(!this.mouseTarget)return;var c=Vector2.getEventPosition(d).sub(this.pos);function b(j,k,i){return Math.max(j,Math.min(i,k));}var a=this.box,g=this.min_width,f=this.min_height;var h=this.wrapper.offsetWidth,e=this.wrapper.offsetHeight;if(this.mouseTarget==this.viewport){c.x=b(-a[3],c.x,h-a[1]);c.y=b(-a[0],c.y,e-a[2]);a[0]+=c.y;a[1]+=c.x;a[2]+=c.y;a[3]+=c.x;}else if(CSS.hasClass(this.mouseTarget,'ne')){a[1]+=c.x=b(a[3]+g-a[1],c.x,h-a[1]);a[0]+=c.y=b(-a[0],c.y,a[2]-f-a[0]);}else if(CSS.hasClass(this.mouseTarget,'nw')){a[3]+=c.x=b(-a[3],c.x,a[1]-g-a[3]);a[0]+=c.y=b(-a[0],c.y,a[2]-f-a[0]);}else if(CSS.hasClass(this.mouseTarget,'se')){a[1]+=c.x=b(a[3]+g-a[1],c.x,h-a[1]);a[2]+=c.y=b(a[0]+f-a[2],c.y,e-a[2]);}else if(CSS.hasClass(this.mouseTarget,'sw')){a[3]+=c.x=b(-a[3],c.x,a[1]-g-a[3]);a[2]+=c.y=b(a[0]+f-a[2],c.y,e-a[2]);}this.redraw();this.pos=this.pos.add(c);return false;};Photocrop.prototype.mouseup=function(a){this.mouseTarget=null;CSS.removeClass(document.body,'draggingMode');};
function PhotoTags(b,a,c){this.tagTargets=b;this.tagBox=a;this.version=c||PhotosConst.VIEWER_PERMALINK;this.handlers=[];this.tagTargets.each(function(d){this.handlers.push(Event.listen(d,{mouseover:this.showTag.bind(this),mouseout:this.hideTags.bind(this)}));}.bind(this));this.subscriptions=[];if(this.version==PhotosConst.VIEWER_SNOWBOX)this.subscriptions.push(Arbiter.subscribe(PhotoSnowbox.PAGE,this.hideTags.bind(this)));}PhotoTags.prototype={showTag:function(event){var g=event.getTarget(),d=CSS.hasClass(g,'taggee'),c=CSS.hasClass(g,'uiProfilePhotoMedium'),f=null;if(d){f=g.getAttribute('data-tag');}else if(c){var b=Parent.byTag(g,'a');f=b&&b.getAttribute('data-tag');}var e=this.version==PhotosConst.VIEWER_PERMALINK?'perm:tag:'+f:'tag:'+f;var a=e&&ge(e);if(a){CSS.addClass(a,'showTag');CSS.addClass(this.tagBox,'showingTag');}},hideTags:function(){CSS.removeClass(this.tagBox,'showingTag');DOM.scry(this.tagBox,'div.showTag').each(function(a){CSS.removeClass(a,'showTag');});},destroy:function(){for(var a in this.handlers)this.handlers[a].remove();this.subscriptions.each(Arbiter.unsubscribe.bind(Arbiter));}};
function TagToken(a){this.parent.construct(this,a,'tag');}Class.extend(TagToken,'Token');TagToken.prototype={createElement:function(){var a=this.isFreeform();var b=$N('span',{className:'separator'},', ');var c=$N(a?'span':'a',{className:'taggee','data-tag':this.getValue()},this.getText());if(!a)c.href=this.getInfo().path;return $N('span',{className:'tagItem'},[b,c]);}};
function TagTokenizer(e,a,b,d){this.parent.construct(this,b,d);this.version=e;this.appphoto=a;var c;switch(this.version){case PhotosConst.VIEWER_PERMALINK:c=PhotoPermalink.DATA_CHANGE;break;case PhotosConst.VIEWER_SNOWBOX:c=PhotoSnowbox.DATA_CHANGE;break;case PhotosConst.VIEWER_SNOWLIFT:c=PhotoSnowlift.DATA_CHANGE;break;}Arbiter.subscribe(c,this.setup.bind(this),Arbiter.SUBSCRIBE_NEW);Arbiter.subscribe(PhotoInlineEditor.CANCEL_INLINE_EDITING,this.updateTokenareaVisibility.bind(this),Arbiter.SUBSCRIBE_NEW);}Class.extend(TagTokenizer,'Tokenizer');TagTokenizer.prototype={setup:function(a,b){this.appphoto=b.byapp;this.byowner=b.isowner;return this.reset();},reset:function(){var a=this.getTokenElements().map(this.getTokenDataFromTag.bind(this));this.withTagKeys={};var b=this.getWithTagTokenElements().map(function(c){return this._tokenKey(this.getTokenDataFromTag(c));}.bind(this));this.withTagKeys=Object.from(b);Input.reset(this.input);return this.parent.reset(a);},processEvents:function(event,b,a){if(Parent.byClass(b,'remove')){var c=this.getTokenFromElement(a);c=this.addTokenData(c,b);this.removeToken(c);event.kill();}},insertToken:function(a){return null;},removeToken:function(a){if(this.appphoto){return this.replaceToken(a);}else{this.inform('removeToken',a);Arbiter.inform('Form/change',{node:this.element});}},addTokenData:function(b,a){if(Parent.byClass(a,'blockuser'))b.blockUser=true;return b;},getTokenDataFromTag:function(a){return {uid:DOM.find(a,'input').value,text:DOM.getText(DOM.find(a,'.taggee'))};},getTokenElementFromTarget:function(a){return Parent.byClass(a,'tagItem');},getTokenElements:function(){return DOM.scry(this.tokenarea,'span.tagItem').filter(this.filterNonTokenElements.bind(this));},getWithTagTokenElements:function(){return DOM.scry(this.tokenarea,'span.withTagItem');},filterNonTokenElements:function(a){return !CSS.hasClass(a,'markasspam')&&!CSS.hasClass(a,'reported')&&!CSS.hasClass(a,'withTagItem');},createToken:function(b,a){var c=this.getToken(this._tokenKey(b));c=c||new TagToken(b);a&&c.setElement(a);return c;},updateTokenareaVisibility:function(){visibleTokens=this.getTokenElements().filter(function(a){return CSS.shown(a);});withTagTokens=this.getWithTagTokenElements();CSS.conditionShow(this.tokenarea,visibleTokens.length!==0||withTagTokens.length!==0);},replaceToken:function(e){if(!e)return;var b=this.tokens.indexOf(e);if(b<0)return;this.tokens.splice(this.tokens.indexOf(e),1);delete this.unique[this._tokenKey(e.getInfo())];var a=ge('tagspam'+e.getValue());a&&DOM.remove(a);var c=[' [',"Identification retir\u00e9e.",' '];c.push($N('a',{onclick:this.markAsSpam.bind(this,e.getValue())},"Marquer l\u2019identification comme ind\u00e9sirable"));c.push('] ');var d=$N('span',{className:'fbPhotosTaglistTag tagItem markasspam',id:'tagspam'+e.getValue()},c);DOM.replace(e.getElement(),d);this.updateTokenarea();this.inform('removeToken',e);Arbiter.inform('Form/change',{node:this.element});},markAsSpam:function(d){var a=ge('tagspam'+d);var b=[' [',"Identification signal\u00e9e",'] '];var c=$N('span',{className:'fbPhotosTaglistTag tagItem reported',id:'tagspam'+d},b);DOM.replace(a,c);this.inform('markTagAsSpam',d);}};
var share_last_comment={p:null,t:null};function share_internal_config(a){if(share_last_comment.p==a){a+='&c='+encodeURIComponent(share_last_comment.t?share_last_comment.t:'');}else share_last_comment.p=a;Bootloader.loadComponents(['async','dialog'],function(){var b=new AsyncRequest().setURI('/ajax/sharer/?'+a).setMethod('GET').setReadOnly(true);var c=new Dialog().setAsync(b).setStackable(true).show();});return false;}
var StickyPlaceholderInput=(function(){var b=function(d){return Parent.byClass(d,'uiStickyPlaceholderInput');};var a=function(d){return DOM.scry(d,'.placeholder')[0];};var c=function(d){d=d||window.event;var e=d.target||d.srcElement;if(DOM.isNodeOfType(e,['input','textarea'])){var f=b(e);if(f){var g=d.type;(function(){if(g=='keydown'&&e.value.length)CSS.removeClass(f,'uiStickyPlaceholderEmptyInput');if((g=='blur'||g=='focusout')&&!e.value.length)CSS.addClass(f,'uiStickyPlaceholderEmptyInput');}).defer();}}};return {init:function(){StickyPlaceholderInput.init=bagofholding;Event.listen(document.documentElement,'keydown',c);if(document.documentElement.addEventListener){document.documentElement.addEventListener('blur',c,true);}else Event.listen(document.documentElement,'focusout',c);},registerInput:function(e){StickyPlaceholderInput.init();var f=e.getAttribute('placeholder')||'';if(f.length)if(document.activeElement===e){var d=Event.listen(e,'blur',function(){StickyPlaceholderInput.manipulateInput(e,f);d.remove();});}else StickyPlaceholderInput.manipulateInput(e,f);},manipulateInput:function(d,e){var f=$N('div',{className:'placeholder',ariaHidden:true},e);var g=$N('div',{className:'uiStickyPlaceholderInput'},f);if(DOM.isNodeOfType(d,'textarea'))CSS.addClass(g,'uiStickyPlaceholderTextarea');Event.listen(f,'click',function(){d.focus();});if(d.value===e)d.value='';CSS.removeClass(d,'DOMControl_placeholder');d.setAttribute('placeholder','');DOM.replace(d,g);DOM.appendContent(g,d);CSS.conditionClass(g,'uiStickyPlaceholderEmptyInput',!d.value.length);},setPlaceholderText:function(d,g){var f=b(d);var e=a(f);e&&DOM.setContent(e,g);},getPlaceholderText:function(d){var f=b(d);var e=a(f);return e&&DOM.getText(e);},update:function(d){var e=b(d);if(e)CSS.conditionClass(e,'uiStickyPlaceholderEmptyInput',!d.value.length);},getVisibleText:function(d){var f=b(d);if(CSS.hasClass(f,'uiStickyPlaceholderEmptyInput')){var e=a(f);return e&&DOM.getText(e);}else return d.value;}};})();
add_properties('TokenizerBehaviors',{freeform:function(f,b){var d=b.tokenize_on_blur!==false;var e=b.tokenize_on_paste!==false;var c=b.matcher&&new RegExp(b.matcher,'i');function a(event){var h=Input.getValue(f.getInput()).trim();if(h&&(!c||c.test(h))){var g={uid:h,text:h,freeform:true};f.addToken(f.createToken(g));if(event){f.getTypeahead().getCore().afterSelect();event.kill();}}}f.subscribe('keydown',function(g,i){var event=i.event;var h=Event.getKeyCode(event);if(h==KEYS.COMMA||h==KEYS.RETURN){var j=f.getTypeahead().getView();if(j.getSelection()){j.select();event.kill();}else a(event);}});f.subscribe('paste',function(g,h){if(e)a.bind(null,h.event).defer(20);});f.subscribe('blur',function(g,h){if(d)a();f.getTypeahead().getCore().reset();});}});
add_properties('TypeaheadBehaviors',{hintText:function(a){a.getCore().resetOnKeyup=false;}});
function VideoHistogram(){this.videos={};this.video_payloads={};this.listening=false;this.checking=false;}VideoHistogram.prototype.start=function(b){var a=document[b]||window[b];this.videos[b]=a;this.listening=true;};VideoHistogram.prototype.videoFinished=function(d,c){this.videos[d]=null;this.setPayload(d,c);this.updateServer();if(Dialog){var b=Dialog.getCurrent();if(b){var a=b.getButtonElement('collect-credits');a&&Button.setEnabled(a,true);}}};VideoHistogram.prototype.setPayload=function(b,a){this.video_payloads[b]=a;};VideoHistogram.prototype.updateServer=function(){var a=[];for(var c in this.video_payloads){var d=this.video_payloads[c];this.video_payloads[c]=null;if(d)a.push(d);}var b=JSON.stringify(a);new AsyncSignal('/video/motion_log.php',{h:b}).send();this.listening=false;this.checking=false;};VideoHistogram.prototype.checkStatus=function(){if(this.listening){this.checking=true;for(var a in this.videos)if(this.videos[a].reportTime)this.videos[a].reportTime();this.updateServer();}};copy_properties(VideoHistogram,{init:function(){if(!window.video_histogram)window.video_histogram=new VideoHistogram();onbeforeunloadRegister(function(){if(!window.video_histogram.checking)window.video_histogram.checkStatus();});}});
var VideoPermalinkTagger={show:function(){CSS.removeClass($('tagger'),'tagger_inactive');$('tagger_input').focus();},hide:function(){CSS.addClass($('tagger'),'tagger_inactive');},setDataSource:function(a){VideoPermalinkTagger._datasource=a;},setExcluded:function(d,b){var a=VideoPermalinkTagger._datasource;var c=a.getExclusions();d=parseInt(d,10);if(b===false){c.remove(d);}else if(!c.contains(d))c.push(d);a.setExclusions(c);}};function motion_rotate_video(b,a){new AsyncRequest().setURI('/ajax/motion.php').setData({v:b,rotate:a}).setFinallyHandler(function(c){$('rotate_wait').style.display='none';$('rotate_links').style.display='';}).send();$('rotate_links').style.display='none';$('rotate_wait').style.display='';}